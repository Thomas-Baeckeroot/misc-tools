# TRF Binary Parser for VidStab

## Overview

This Python script parses and analyzes TRF (transform) files generated by VidStab's `vidstabdetect` filter in FFmpeg. These files contain frame-by-frame transformation data used for video stabilization.

## Background

VidStab is a video stabilization library that works with FFmpeg in a two-pass process:
1. **First pass**: `vidstabdetect` analyzes the video and generates a `.trf` file with motion data
2. **Second pass**: `vidstabtransform` uses the `.trf` file to stabilize the video

## Problem Statement

Recent versions of VidStab have switched from an ASCII text format to a binary format for TRF files. This change has introduced several issues:

- **Poor documentation**: The binary format structure is not officially documented
- **Portability problems**: The format has known issues on Windows/mingw systems
- **Parsing difficulties**: Even FFmpeg's own `vidstabtransform` filter sometimes fails to read these files
- **Format inconsistencies**: Header information often appears corrupted or incorrect

## TRF File Format (Reverse-Engineered)

Based on analysis, the binary TRF format appears to have:

### Header Structure
- **Magic number**: "TRF1" (4 bytes)
- **Version**: Integer (4 bytes) 
- **Frame count**: Integer (4 bytes) - Often incorrect in current versions
- **Data size**: Integer (4 bytes)
- Additional fields of unknown purpose

### Transform Records
Each frame's transformation data typically includes:
- **dx**: Horizontal displacement (float)
- **dy**: Vertical displacement (float)
- **da**: Angular rotation in radians (float)
- Additional data (possibly motion vectors, confidence scores, etc.)

The exact record size varies and appears to be much larger than the basic 3 floats (12 bytes) needed for dx/dy/da.

## Usage

### Basic Commands

```bash
# Analyze a single TRF file
python3 trf_parser.py analyse <file.trf>

# Compare two TRF files
python3 trf_parser.py compare <file1.trf> <file2.trf>
```

### Example with FFmpeg

```bash
# Generate TRF file with vidstabdetect
ffmpeg -i input.mp4 -vf vidstabdetect=shakiness=10:accuracy=15:result=transforms.trf -f null -

# Analyze the generated TRF
python3 trf_parser.py analyse transforms.trf
```

## Features

- **Format detection**: Automatically detects ASCII vs binary format
- **Structure analysis**: Attempts to determine record size and frame count
- **Stability metrics**: Calculates RMS, mean absolute values, and instability index
- **Validation**: Filters out invalid/corrupted transform data
- **Comparison**: Compare stability metrics between two TRF files

## Known Issues

1. **Header parsing**: The frame count in the header is often incorrect (e.g., showing 10 frames for a video with 16,000+ frames)
2. **Large file sizes**: Binary TRF files are unexpectedly large (40+ MB for a 4-minute video)
3. **Format variations**: Different versions of VidStab may use different binary formats
4. **Corrupted data**: Many transform values appear as NaN or extremely large numbers

## Technical Details

### Expected Frame Count Calculation
For a video of duration T seconds at F fps:
```
Expected frames = T × F
```

Example: 4 minutes 35 seconds at 59.94 fps ≈ 16,514 frames

### Record Size Detection
The script tests various header sizes (16-256 bytes) and record sizes (24-2048 bytes) to find configurations that:
1. Divide evenly into the file size
2. Produce a reasonable frame count
3. Parse successfully without NaN or extreme values

## Future Improvements

- [ ] Support for ASCII format export
- [ ] Binary to ASCII conversion
- [ ] Better handling of format variations
- [ ] Integration with FFmpeg pipeline
- [ ] Support for `global_motions.trf` format

## References

- [VidStab GitHub Repository](https://github.com/georgmartius/vid.stab)
- [FFmpeg VidStab Documentation](https://ffmpeg.org/ffmpeg-filters.html#vidstabdetect)
- [Known Windows/Binary Format Issue](https://github.com/georgmartius/vid.stab/issues/104)

## License

This script is provided as-is for educational and debugging purposes. Use at your own risk when working with production video files.

## Contributing

If you discover more about the TRF binary format or find solutions to the parsing issues, please contribute your findings!